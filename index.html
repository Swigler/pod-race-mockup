import asyncio
import time
import pod_handler

user_credits: dict = {}
INITIAL_CREDITS = 3600  # 1 hour in seconds

def log(message: str):
    print(f"[DEBUG {time.strftime('%H:%M:%S')}] {message}")

def start_tracking(user_id: str):
    if user_id not in user_credits:
        user_credits[user_id] = INITIAL_CREDITS
        log(f"Started tracking credits for {user_id}: {INITIAL_CREDITS}s")

def stop_tracking(user_id: str):
    if user_id in user_credits:
        del user_credits[user_id]
        log(f"Stopped tracking credits for {user_id}")

async def check_credits():
    while True:
        for user_id in list(user_credits.keys()):
            if user_id in pod_handler.user_to_winner:
                user_credits[user_id] -= 1
                log(f"{user_id} credits: {user_credits[user_id]:.2f}s")
                if user_credits[user_id] <= 0:
                    winner_type = pod_handler.user_to_winner[user_id]
                    log(f"Credits out for {user_id}: deleting winner {winner_type}")
                    pod_handler.stop_pod(pod_handler.spawned_pods[winner_type], terminate=True)
                    del pod_handler.user_to_winner[user_id]
                    del user_credits[user_id]
            else:
                del user_credits[user_id]
        await asyncio.sleep(1)
